***Settings***
Library         Process
Library         Collections
Library         String
Library         ./NVDsearch.py
Library         ./profinetscanner.py
Library         ./cotpquery.py
Library         ./S7-1200manipulator.py

***Variables***
${TARGET}           Profinet
${ETH_INTERFACE}    enx0050b66b034c
${IP}               192.168.250.129
@{IP_LIST}          
${NEW_OUTPUT}       00000
#11111

***Test Cases***
# Be noted that some of the used scripts need administrative priviledges to run.

ProfinetScanTestCase
    #Search and display vulnerabilities
    Scan for profinet devices
    Query COTP
SimaticS7ExploitTestCase
    Read Simatic PLC parameters
    Write to Simatic PLC outputs

***Keywords***
Search and display vulnerabilities
    [Documentation]     Runs online search for vulnerabilities with given parameter.
    ...                 Opens website with two tabs, one for the search and one for statistics on that search.
    Search from NVD database    ${TARGET}


Scan for profinet devices
    [Documentation]     Runs PROFINET scanner as a python module. Note: Needs administrative priviledges to run.
    ...                 Logs the results with warning level to see the results in console and log.
    ...                 Saves the IP addresses of found devices for further operations.
    [Timeout]           3 seconds
    ${resultDict}=                  Run PROFINET scanner    ${ETH_INTERFACE}
    Log PROFINET scan results       ${resultDict}           ${TRUE}
    Save found IP addresses                     ${resultDict}

Query COTP
    [Documentation]     Sends COTP query to specified IP, which Siemens devices can respond with additional information.
    Send COTP query         ${IP_LIST}[0]


Run Profinet scanner externally
    [Documentation]     Runs PROFINET scanner as an external program like from commandprompt.
    ...                 Logs the output at WARN level to output stdout to both log and console.
    Start Process       python  ./profinetscanner.py       -i ${ETH_INTERFACE}
    ${result}           Wait For Process                    timeout=${WAITTIME}      on_timeout=terminate
    Should be equal as integers     ${result.rc}            0
    log                             ${result.stdout}        WARN    

Save found IP addresses
    [Documentation]     Saves IP addresses in multi-level dict to an array.
    [Arguments]         ${IP_dict}
    FOR     ${Key}    IN      @{IP_dict}
            ${Inner_dict}=      Get From Dictionary     ${IP_dict}           ${Key}
            ${IP}=              Get From Dictionary     ${Inner_dict}       ip_address
            Append To List      ${IP_LIST}              ${IP}
    END    

Read Simatic PLC parameters
    [Documentation]     Attempts to read Siemens Simatic S7-1200 outputs, inputs and merkers
    ...                 through S7Comm protocol.
    [Arguments]         ${SCOPE}=ALL
    [Timeout]           3 seconds
    Read S7-1200 parameters     ${IP_LIST}[0]       ${SCOPE}

Write to Simatic PLC outputs
    [Documentation]     Attempts to write to Siemens Simatic S7-1200 outputs.
    ...                 Accepts string of 1 or 0 values to be written. Afterwards values are read
    ...                 to see if writing was succesful.
    [Timeout]           3 seconds
    Write to S7-1200 outputs    ${IP_LIST}[0]       ${NEW_OUTPUT}
    ${INFO}=        Format string   Wrote {output} to {ip} outputs      output=${NEW_OUTPUT}        ip=${IP_LIST}[0]
    log             ${INFO}         WARN
    Read Simatic PLC parameters     OUTPUTS